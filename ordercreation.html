<!DOCTYPE html>
<html>
<head>
    <title>Tạo Đơn Hàng Trading</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        input, select { width: 100%; margin-bottom: 10px; padding: 10px; box-sizing: border-box; }
        button { background-color: #2481cc; color: white; border: none; padding: 10px 20px; width: 100%; border-radius: 5px; cursor: pointer; }
        .total-display-container { 
            margin-bottom: 10px; 
            padding: 10px; 
            border: 1px solid #ccc; 
            background-color: #f9f9f9; 
            text-align: right; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-label { color: #555; }
        .total-amount { font-weight: bold; font-size: 1.1em; color: #000; }
    </style>
</head>
<body>
    <h3>Lên Đơn Hàng Mới</h3>
    
    <input type="date" id="deliveryDate" placeholder="Ngày nhận hàng"> 
    <input type="text" id="customer" placeholder="Tên khách hàng">
    
    <select id="product">
        <option value="">Chọn Sản phẩm (Mã hàng hóa)</option>
        <option value="PE">Hạt nhựa PE (Polyethylene)</option>
        <option value="PP">Hạt nhựa PP (Polypropylene)</option>
        <option value="PVC">Hạt nhựa PVC (Polyvinyl Chloride)</option>
        <option value="PET">Hạt nhựa PET (Polyethylene Terephthalate)</option>
        <option value="ABS">Hạt nhựa ABS (Acrylonitrile Butadiene Styrene)</option>
        <option value="PS">Hạt nhựa PS (Polystyrene)</option>
        <option value="PA">Hạt nhựa PA (Polyamide/Nylon)</option>
    </select>
    
    <input type="number" id="quantity" placeholder="Số lượng" oninput="calculateTotal()">
    <input type="number" id="price" placeholder="Đơn giá" oninput="calculateTotal()">
    
    <div class="total-display-container">
        <span class="total-label">Thành tiền:</span>
        <span class="total-amount" id="totalAmountDisplay" data-value="0">0 VND</span>
    </div>
    
    <button onclick="sendOrder()">Gửi Đơn Hàng</button>

<script>
    // Khởi tạo WebApp
    let tg = window.Telegram.WebApp;
    tg.expand(); 

    // CHỈ KHAI BÁO URL ở ngoài để dễ đọc
    const n8nWebhookUrl = 'https://n8ncamundatest1.app.n8n.cloud/webhook-test/05aebebd-962b-4285-b2af-a62300358208';

    /**
     * Hàm tính toán Thành tiền (Số lượng X Giá)
     */
    function calculateTotal() {
        const quantity = parseFloat(document.getElementById("quantity").value) || 0;
        const price = parseFloat(document.getElementById("price").value) || 0;
        
        const total = quantity * price;
        
        // Định dạng số để hiển thị
        const formattedTotal = total.toLocaleString('vi-VN', { 
            style: 'currency', 
            currency: 'VND',
            minimumFractionDigits: 0
        });

        // Cập nhật hiển thị
        document.getElementById("totalAmountDisplay").textContent = formattedTotal;
        // Lưu giá trị số vào data-value để gửi đi
        document.getElementById("totalAmountDisplay").dataset.value = total;
    }

    function sendOrder() {
        // Lấy dữ liệu khi người dùng bấm nút
        let data = {
            customer: document.getElementById("customer").value,
            // Lấy giá trị từ Select (Drop-down list)
            product: document.getElementById("product").value, 
            quantity: document.getElementById("quantity").value,
            price: document.getElementById("price").value,
            
            deliveryDate: document.getElementById("deliveryDate").value,
            // Lấy giá trị số từ data-value của trường Thành tiền
            totalAmount: document.getElementById("totalAmountDisplay").dataset.value, 
            
            action: "create_order",
            telegram_user_id: tg.initDataUnsafe?.user?.id 
        };

        // 2. Kiểm tra dữ liệu cơ bản (Validation)
        // Bổ sung kiểm tra product (select) phải có giá trị
        if (!data.customer || !data.product || data.quantity <= 0 || !data.deliveryDate || data.totalAmount <= 0) {
            tg.showAlert("Vui lòng điền đủ Tên khách hàng, Chọn Sản phẩm, Số lượng, Đơn giá hợp lệ và Ngày nhận hàng.");
            return; // Dừng nếu dữ liệu không hợp lệ
        }

        // 3. Thực hiện FETCH
        fetch(n8nWebhookUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => {
            if (response.ok) {
                tg.showAlert("Đã gửi đơn hàng thành công!");
                tg.close();
            } else {
                tg.showAlert(`Lỗi HTTP: ${response.status}. Không gửi được đơn hàng.`);
            }
        })
        .catch((error) => {
            tg.showAlert("Lỗi kết nối mạng hoặc server: " + error.message);
        });
    }

    // Tính toán lần đầu khi load trang
    calculateTotal();
</script>
</body>
</html>
