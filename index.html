<!DOCTYPE html>
<html>
<head>
    <title>Tạo Đơn Hàng Trading</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        input, select { width: 100%; margin-bottom: 10px; padding: 10px; }
        button { background-color: #2481cc; color: white; border: none; padding: 10px 20px; width: 100%; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h3>Lên Đơn Hàng Mới</h3>
    <input type="text" id="customer" placeholder="Tên khách hàng">
    <input type="text" id="product" placeholder="Mã hàng hóa">
    <input type="number" id="quantity" placeholder="Số lượng">
    <input type="number" id="price" placeholder="Đơn giá">
    <button onclick="sendOrder()">Gửi Đơn Hàng</button>

<script>
    // Khởi tạo WebApp
    let tg = window.Telegram.WebApp;
    tg.expand(); 

    // CHỈ KHAI BÁO URL ở ngoài để dễ đọc
    const n8nWebhookUrl = 'https://nlpilot.app.n8n.cloud/webhook-test/e4904d77-603d-4400-93c3-e47bf699421f';

    function sendOrder() {
        // TOÀN BỘ LOGIC LẤY DATA VÀ GỌI FETCH PHẢI Ở TRONG HÀM NÀY
        
        // 1. Lấy dữ liệu khi người dùng bấm nút
        let data = {
            customer: document.getElementById("customer").value,
            product: document.getElementById("product").value,
            quantity: document.getElementById("quantity").value,
            price: document.getElementById("price").value,
            action: "create_order",
            // Lấy User ID
            telegram_user_id: tg.initDataUnsafe?.user?.id 
        };

        // 2. Kiểm tra dữ liệu cơ bản (Validation)
        if (!data.customer || !data.product || data.quantity <= 0) {
            tg.showAlert("Vui lòng điền đủ Tên khách hàng, Mã hàng và Số lượng hợp lệ.");
            return; // Dừng nếu dữ liệu không hợp lệ
        }

        // 3. Thực hiện FETCH (Chỉ khi người dùng bấm nút)
        fetch(n8nWebhookUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => {
            // Kiểm tra HTTP status code (ví dụ: 200, 202)
            if (response.ok) {
                tg.showAlert("Đã gửi đơn hàng thành công!");
                tg.close();
            } else {
                tg.showAlert(`Lỗi HTTP: ${response.status}. Không gửi được đơn hàng.`);
            }
        })
        .catch((error) => {
            // Lỗi network hoặc lỗi khác
            tg.showAlert("Lỗi kết nối mạng hoặc server: " + error.message);
        });
    }
</script>
</body>
</html>
