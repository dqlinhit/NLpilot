<!DOCTYPE html>
<html>
<head>
    <title>Tạo Đơn Hàng Trading</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        
        /* CSS cho Label và Input/Select */
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 0.9em; /* Giảm kích thước font cho label */
        }
        
        input, select { 
            width: 100%; 
            padding: 10px; 
            box-sizing: border-box; 
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        button { 
            background-color: #2481cc; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            width: 100%; 
            border-radius: 5px; 
            cursor: pointer;
            margin-top: 10px;
        }
        .total-display-container { 
            margin-bottom: 10px; 
            padding: 10px; 
            border: 1px solid #ccc; 
            background-color: #e9e9e9; /* Màu nền khác biệt */
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-label { color: #555; }
        .total-amount { font-weight: bold; font-size: 1.1em; color: #000; }
    </style>
</head>
<body>
    <h3>Lên Đơn Hàng Mới</h3>
    
    <div class="form-group">
        <label for="deliveryDate">Ngày nhận hàng:</label>
        <input type="date" id="deliveryDate"> 
    </div>
    
    <div class="form-group">
        <label for="customer">Tên khách hàng:</label>
        <input type="text" id="customer" placeholder="Nhập tên khách hàng">
    </div>
    
    <div class="form-group">
        <label for="product">Sản phẩm (Mã hàng hóa):</label>
        <select id="product">
            <option value="">-- Chọn Sản phẩm --</option>
            <option value="PE">Hạt nhựa PE (Polyethylene)</option>
            <option value="PP">Hạt nhựa PP (Polypropylene)</option>
            <option value="PVC">Hạt nhựa PVC (Polyvinyl Chloride)</option>
            <option value="PET">Hạt nhựa PET (Polyethylene Terephthalate)</option>
            <option value="ABS">Hạt nhựa ABS (Acrylonitrile Butadiene Styrene)</option>
            <option value="PS">Hạt nhựa PS (Polystyrene)</option>
            <option value="PA">Hạt nhựa PA (Polyamide/Nylon)</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="quantity">Số lượng:</label>
        <input type="number" id="quantity" placeholder="Nhập số lượng" oninput="calculateTotal()">
    </div>
    
    <div class="form-group">
        <label for="price">Đơn giá:</label>
        <input type="number" id="price" placeholder="Nhập đơn giá" oninput="calculateTotal()">
    </div>
    
    <div class="total-display-container">
        <span class="total-label">Thành tiền:</span>
        <span class="total-amount" id="totalAmountDisplay" data-value="0">0 VND</span>
    </div>
    
    <button onclick="sendOrder()">Gửi Đơn Hàng</button>

<script>
    // Khởi tạo WebApp
    let tg = window.Telegram.WebApp;
    tg.expand(); 

    // URL Webhook của n8n
    const n8nWebhookUrl = 'https://n8ncamundatest1.app.n8n.cloud/webhook-test/05aebebd-962b-4285-b2af-a62300358208';

    /**
     * Hàm tính toán Thành tiền (Số lượng X Giá)
     */
    function calculateTotal() {
        const quantity = parseFloat(document.getElementById("quantity").value) || 0;
        const price = parseFloat(document.getElementById("price").value) || 0;
        
        const total = quantity * price;
        
        // Định dạng số để hiển thị
        const formattedTotal = total.toLocaleString('vi-VN', { 
            style: 'currency', 
            currency: 'VND',
            minimumFractionDigits: 0
        });

        // Cập nhật hiển thị và data-value (giá trị số)
        document.getElementById("totalAmountDisplay").textContent = formattedTotal;
        document.getElementById("totalAmountDisplay").dataset.value = total;
    }

    /**
     * Hàm gửi đơn hàng
     */
    function sendOrder() {
        // 1. Lấy dữ liệu
        let data = {
            customer: document.getElementById("customer").value,
            product: document.getElementById("product").value, 
            quantity: document.getElementById("quantity").value,
            price: document.getElementById("price").value,
            
            deliveryDate: document.getElementById("deliveryDate").value,
            totalAmount: document.getElementById("totalAmountDisplay").dataset.value, 
            
            action: "create_order",
            telegram_user_id: tg.initDataUnsafe?.user?.id 
        };

        // 2. Kiểm tra dữ liệu cơ bản (Validation)
        if (!data.customer || !data.product || data.quantity <= 0 || !data.deliveryDate || data.totalAmount <= 0) {
            tg.showAlert("Vui lòng điền đủ Tên khách hàng, Chọn Sản phẩm, Số lượng, Đơn giá hợp lệ và Ngày nhận hàng.");
            return; 
        }

        // 3. Thực hiện FETCH
        fetch(n8nWebhookUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => {
            if (response.ok) {
                tg.showAlert("Đã gửi đơn hàng thành công!");
                tg.close();
            } else {
                tg.showAlert(`Lỗi HTTP: ${response.status}. Không gửi được đơn hàng.`);
            }
        })
        .catch((error) => {
            tg.showAlert("Lỗi kết nối mạng hoặc server: " + error.message);
        });
    }

    // Tính toán lần đầu khi load trang
    calculateTotal();
</script>
</body>
</html>
